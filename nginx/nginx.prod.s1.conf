# nginx.prod.s1.conf

upstream frontend_upstream {
    server frontend-primary:80 weight=10;
    server 10.1.11.17:28080 backup;
    keepalive 32;
}

upstream backend_upstream {
    server backend-primary:8000 weight=10;
    server 10.1.11.17:28000 backup;
    keepalive 32;
}

upstream analytics_upstream {
    server analytics-primary:8000 weight=10;
    server 10.1.11.17:28100 backup;
    keepalive 32;
}

upstream backend_stg { 
   server backend-stg:8000;
}

upstream analytics_stg {
   server analytics-stg:8000;
}

upstream frontend_stg {
   server frontend-stg:80;
}

server {
  listen 80;
  listen [::]:80;
  server_name ccscloud.dlsu.edu.ph;

  access_log /dev/stdout;
  error_log  /dev/stderr info;

  # Increase body size for JSON/posts (optional)
  client_max_body_size 10m;

  # Common proxy headers/timeouts
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_http_version 1.1;
  proxy_connect_timeout 10s;
  proxy_read_timeout    60s;

  # Prefer the primary; if it’s down, try backup
  proxy_next_upstream error timeout http_502 http_503 http_504;
  proxy_next_upstream_tries 2;

 # ---- STAGING (put these before the generic / block) ----
  # ensure trailing slash for SPA base=/staging/
  # ensure trailing slash for SPA base
  
  location = /staging { 
    return 301 /staging/; 
    }

  # serve assets directly (avoid SPA fallback)
  location ^~ /staging/assets/ {
    proxy_pass http://frontend_stg/assets/;
  }

  # STAGING APIs — backend
  location ^~ /staging/api/ {
    rewrite ^/staging/api/?(.*)$ /$1 break;   # /staging/api/x -> /x
    proxy_pass http://backend_stg;
  }

  # STAGING Analytics — ***must go to analytics_stg***
  location ^~ /staging/analytics/ {
    rewrite ^/staging/analytics/?(.*)$ /$1 break;  # /staging/analytics/x -> /x
    proxy_pass http://analytics_stg;
  }

  # SPA shell (staging UI) last
  location /staging/ {
    proxy_pass http://frontend_stg/;
  }

  # ---- PRODUCTION ----
  # 1) /api → backend ROOT (strip /api)
  location /api/ {
    proxy_pass http://backend_upstream/;   # NOTE trailing slash → /api/foo -> /foo
  }

  # 2) /analytics → analytics ROOT (strip /analytics)
  location /analytics/ {
    proxy_pass http://analytics_upstream/; # NOTE trailing slash
  }

  # 3) Frontend (SPA): serve everything else from frontend
  location / {
    proxy_pass http://frontend_upstream;   # NO trailing slash → keep paths as-is
  }

  # (Optional) health endpoint straight to backend
  location = /healthz {
    proxy_pass http://backend_upstream/health;
  }
}

